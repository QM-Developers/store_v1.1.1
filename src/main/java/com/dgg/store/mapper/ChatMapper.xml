<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dgg.store.mapper.ChatMapper">
    <resultMap id="ChatHistoryMap" type="com.dgg.store.util.pojo.ChatHistory">
        <result column="history_id" property="historyId" jdbcType="VARCHAR"/>
        <result column="send_user_id" property="sendUserId" jdbcType="VARCHAR"/>
        <result column="receive_user_id" property="receiveUserId" jdbcType="VARCHAR"/>
        <result column="data_type" property="dataType" jdbcType="INTEGER"/>
        <result column="send_data" property="sendData" jdbcType="VARCHAR"/>
        <result column="send_time" property="sendTime" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="FriendVO" type="com.dgg.store.util.vo.friend.FriendVO">
        <id column="user_id" property="userId" jdbcType="VARCHAR"/>
        <result column="user_name" property="friendName" jdbcType="VARCHAR"/>
        <result column="user_phone" property="friendPhone" jdbcType="VARCHAR"/>
        <result column="user_img" property="friendImg" jdbcType="VARCHAR"/>
        <result column="user_area" property="friendArea" jdbcType="VARCHAR"/>
        <result column="user_address" property="friendAddress" jdbcType="VARCHAR"/>
        <result column="user_sex" property="friendSex" jdbcType="VARCHAR"/>
        <result column="friend_id" property="friendId" jdbcType="VARCHAR"/>
        <result column="friend_user_id" property="friendUserId" jdbcType="VARCHAR"/>
        <result column="friend_remark_name" property="friendRemarkName" jdbcType="VARCHAR"/>
        <result column="friend_remark_text" property="friendRemarkText" jdbcType="VARCHAR"/>
    </resultMap>

    <insert id="insertChatMessage" parameterType="com.dgg.store.util.pojo.ChatHistory">
        INSERT INTO chat_history
        (history_id,send_user_id, receive_user_id, data_type, send_data,send_time)
        VALUES
        (#{historyId},#{sendUserId},#{receiveUserId},#{dataType},#{sendData},#{sendTime})
    </insert>

    <select id="findNotReadChatHistoryCount" parameterType="com.dgg.store.util.pojo.ChatHistory" resultMap="ChatHistoryMap">
        SELECT COUNT(1) count,ch.send_user_id ,
          u.user_name,u.user_img,u.user_sex,
          f.friend_remark_name
        FROM chat_history ch
        INNER JOIN user u
        ON u.user_id = ch.send_user_id
        LEFT JOIN friend f
        ON f.user_id = ch.send_user_id AND f.friend_user_id = ch.receive_user_id
        WHERE ch.receive_user_id = #{receiveUserId}
        AND ch.is_read = #{isRead}
        GROUP BY ch.send_user_id
    </select>

    <select id="findChatHistory" parameterType="com.dgg.store.util.pojo.ChatHistory" resultMap="ChatHistoryMap">
        SELECT history_id, send_user_id, receive_user_id,
          data_type, send_data, send_time
        FROM chat_history ch
        WHERE 1 = 1
        <if test="sendUserId != null and sendUserId != ''">
            AND ch.send_user_id = #{sendUserId}
        </if>
        <if test="receiveUserId != null and receiveUserId != ''">
            AND ch.receive_user_id = #{receiveUserId}
        </if>
        <if test="isRead != null">
            AND ch.is_read = #{isRead}
        </if>
        <if test="isReceived != null">
            AND ch.is_received = #{isReceived}
        </if>
        <if test="dataType != null and dataType != 0">
            AND ch.data_type = #{dataType}
        </if>
        ORDER BY ch.send_time DESC
    </select>

    <update id="updateChatHistory" parameterType="com.dgg.store.util.pojo.ChatHistory">
        UPDATE chat_history
        <set>
            <if test="isRead != null">
                is_read = #{isRead},
            </if>
            <if test="isReceived != null">
                is_received = #{isReceived},
            </if>
        </set>
        WHERE 1 = 1
        <if test="sendUserId != null and sendUserId != ''">
            AND send_user_id = #{sendUserId}
        </if>
        <if test="receiveUserId != null and receiveUserId != ''">
            AND receive_user_id = #{receiveUserId}
        </if>
        <if test="historyId != null and historyId != ''">
            AND history_id = #{historyId}
        </if>
    </update>

    <select id="findUserChatInfoById" resultMap="FriendVO">
        SELECT u.user_name,u.user_phone,u.user_area,u.user_address,u.user_img
        FROM user u
        WHERE u.user_id = #{userId}
    </select>

    <select id="countNoReceivedMessage" resultType="java.lang.Integer" parameterType="com.dgg.store.util.pojo.ChatHistory">
        SELECT count(0)
        FROM chat_history
        WHERE 1 = 1
        AND is_received = 0
        AND receive_user_id = #{receiveUserId}
    </select>

    <select id="listNoReceivedMessage" resultMap="ChatHistoryMap" parameterType="com.dgg.store.util.pojo.ChatHistory">
        SELECT history_id, send_user_id, receive_user_id, data_type, send_data, send_time
        FROM chat_history
        WHERE 1 = 1
        AND is_received = 0
        AND receive_user_id = #{receiveUserId}
    </select>
</mapper>