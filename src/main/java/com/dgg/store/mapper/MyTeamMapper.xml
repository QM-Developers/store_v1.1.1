<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dgg.store.mapper.MyTeamMapper">
    <resultMap id="BaseResultMap" type="com.dgg.store.util.pojo.MyTeam">
        <id column="my_team_id" jdbcType="VARCHAR" property="myTeamId"/>
        <result column="store_mall_id" jdbcType="VARCHAR" property="storeMallId"/>
        <result column="my_team_name" jdbcType="VARCHAR" property="myTeamName"/>
        <result column="my_team_create_date" jdbcType="TIMESTAMP" property="myTeamCreateDate"/>
        <result column="my_team_sort" jdbcType="TINYINT" property="myTeamSort"/>
    </resultMap>

    <resultMap id="DepartmentMap" type="com.dgg.store.util.vo.team.TeamDepartmentVO">
        <result column="team_department_id" property="teamDepartmentId" jdbcType="VARCHAR"/>
        <result column="team_department_name" property="teamDepartmentName" jdbcType="VARCHAR"/>
        <result column="department_type" property="departmentType" jdbcType="VARCHAR"/>
        <result column="my_team_id" property="myTeamId" jdbcType="VARCHAR"/>
        <result column="user_id" property="userId" jdbcType="VARCHAR"/>
        <result column="user_phone" property="userPhone" jdbcType="VARCHAR"/>
        <result column="user_name" property="userName" jdbcType="VARCHAR"/>
        <result column="create_date" property="createDate" jdbcType="DATE"/>
        <result column="count" property="count" jdbcType="INTEGER"/>
    </resultMap>

    <resultMap id="DepartmentVOMap" type="com.dgg.store.util.vo.team.DepartmentVO">
        <id column="team_department_id" property="teamDepartmentId" jdbcType="VARCHAR"/>
        <result column="my_team_id" property="myTeamId" jdbcType="VARCHAR"/>
        <result column="team_department_name" property="teamDepartmentName" jdbcType="VARCHAR"/>
        <result column="department_type" property="departmentType" jdbcType="VARCHAR"/>
        <result column="my_team_name" property="corporationName" jdbcType="VARCHAR"/>
        <result column="my_team_area" property="departmentArea" jdbcType="VARCHAR"/>
        <result column="my_team_address" property="departmentAddress" jdbcType="VARCHAR"/>
        <result column="user_name" property="userName" jdbcType="VARCHAR"/>
        <result column="user_phone" property="userPhone" jdbcType="VARCHAR"/>
        <result column="create_date" property="createDate" jdbcType="DATE"/>
    </resultMap>

    <resultMap id="DepartmentMemberVOMap" type="com.dgg.store.util.vo.team.DepartmentMemberVO">
        <result column="user_id" property="userId" jdbcType="VARCHAR"/>
        <result column="user_name" property="userName" jdbcType="VARCHAR"/>
        <result column="user_sex" property="userSex" jdbcType="VARCHAR"/>
        <result column="user_phone" property="userPhone" jdbcType="VARCHAR"/>
        <result column="user_area" property="userArea" jdbcType="VARCHAR"/>
        <result column="user_address" property="userAddress" jdbcType="VARCHAR"/>
        <result column="user_birthday" property="userBirthday" jdbcType="VARCHAR"/>
        <result column="role_id" property="roleId" jdbcType="VARCHAR"/>
        <result column="my_team_name" property="companyName" jdbcType="VARCHAR"/>
        <result column="team_department_name" property="departmentName" jdbcType="VARCHAR"/>
        <result column="team_department_id" property="teamDepartmentId" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="SearchVOMap" type="com.dgg.store.util.vo.core.SearchVO">
        <id column="my_team_id" property="id" jdbcType="VARCHAR"/>
        <result column="my_team_name" property="name" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="TeamVOMap" type="com.dgg.store.util.vo.team.MyTeamVO">
        <result column="my_team_id" property="myTeamId" jdbcType="VARCHAR"/>
        <result column="my_team_name" property="myTeamName" jdbcType="VARCHAR"/>
        <result column="my_team_create_date" property="myTeamCreateDate" jdbcType="VARCHAR"/>
        <result column="my_team_area" property="myTeamArea" jdbcType="VARCHAR"/>
        <result column="my_team_address" property="myTeamAddress" jdbcType="VARCHAR"/>
        <result column="user_name" property="userName" jdbcType="VARCHAR"/>
        <result column="user_phone" property="userPhone" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="TreeMap" type="com.dgg.store.util.vo.core.TreeVO">
        <result column="id" property="id" jdbcType="VARCHAR"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="pid" property="pId" jdbcType="VARCHAR"/>
    </resultMap>

    <insert id="insertMyTeam" parameterType="com.dgg.store.util.vo.team.MyTeamVO">
        INSERT INTO dgg_store.my_team (my_team_id, my_team_name, my_team_create_date,my_team_pid)
        VALUES (#{myTeamId},#{myTeamName},#{myTeamCreateDate},#{myTeamPid})
    </insert>

    <insert id="insertDepartment" parameterType="com.dgg.store.util.pojo.TeamDepartment">
        INSERT INTO dgg_store.team_department(team_department_id,department_type, team_department_name, my_team_id, create_date)
        VALUES
        (#{teamDepartmentId},#{departmentType},#{teamDepartmentName},#{myTeamId},NOW())
    </insert>

    <select id="findDepartmentList" resultMap="DepartmentMap">
        SELECT td.team_department_id,td.team_department_name
        FROM dgg_store.team_department td
        WHERE td.my_team_id = #{teamId}
    </select>

    <select id="findCCDepartmentList" resultMap="DepartmentMap">
        SELECT td.team_department_id,td.team_department_name
        FROM dgg_store.team_department td
        WHERE td.my_team_id =  #{teamId}
        UNION
        SELECT td.team_department_id,td.team_department_name
        FROM dgg_store.team_department td
        WHERE td.my_team_id = (SELECT mt.my_team_pid from dgg_store.my_team mt where mt.my_team_id =  #{teamId})
        AND td.team_department_name =  #{departmentName}
    </select>

    <select id="findDepartmentInfo" resultMap="DepartmentVOMap">
        SELECT td.team_department_id,td.team_department_name,td.create_date,td.department_type,
			mt.my_team_name,mt.my_team_id,mt.my_team_area,mt.my_team_address
        FROM dgg_store.team_department td
        INNER JOIN dgg_store.my_team mt
        ON mt.my_team_id = td.my_team_id
        WHERE td.team_department_id = #{departmentId}
    </select>

    <select id="findDepartmentMemberCount" resultType="java.lang.Integer">
        SELECT COUNT(0)
        FROM dgg_store.user u
        WHERE u.team_department_id = #{departmentId}
    </select>

    <select id="findCompanyList" resultMap="BaseResultMap">
        SELECT mt.my_team_id,mt.my_team_name
        FROM dgg_store.my_team mt
        WHERE mt.my_team_id IN(SELECT mt2.my_team_id FROM dgg_store.my_team mt2 WHERE mt2.my_team_pid = #{teamId})
        OR mt.my_team_id = #{teamId}
    </select>

    <select id="findChildCompany" resultMap="BaseResultMap">
        SELECT mt.my_team_id,mt.my_team_name
        FROM dgg_store.my_team mt
        WHERE mt.my_team_pid = #{teamId}
    </select>

    <insert id="insertDepartmentMember" parameterType="com.dgg.store.util.vo.team.DepartmentMemberVO">
        INSERT INTO dgg_store.user
        (user_id, user_name, user_phone, user_status,
          role_id, my_team_id, team_department_id)
        VALUES
        (#{userId},#{userName},#{userPhone},#{userStatus},
          #{roleId},#{myTeamId},#{teamDepartmentId})
    </insert>

    <select id="findTeamsByKeyword" resultMap="SearchVOMap">
        SELECT mt.my_team_id,mt.my_team_name
        FROM dgg_store.my_team mt
        WHERE mt.my_team_name LIKE CONCAT('%',#{keyword},'%' )
    </select>

    <select id="findCompanyInfo" resultMap="TeamVOMap">
        SELECT mt.my_team_id,mt.my_team_name,mt.my_team_create_date,mt.my_team_area,mt.my_team_address
        FROM dgg_store.my_team mt
        WHERE mt.my_team_id = #{teamId}
    </select>

    <select id="findCompanyPrincipal" resultMap="TeamVOMap">
        SELECT u.user_id,u.user_name,u.user_phone
        FROM dgg_store.user u
        INNER JOIN dgg_store.team_department td
        ON td.team_department_id = u.team_department_id
        WHERE u.role_id > #{roleId}
        AND td.department_type = #{departmentType}
        AND td.my_team_id = #{teamId}
    </select>

    <update id="updateRoleByDepartment">
        UPDATE dgg_store.user
        SET role_id = #{roleId}
        WHERE team_department_id = #{departmentId}
    </update>

    <update id="updateRoleByUser">
        UPDATE dgg_store.user
        SET role_id = #{roleId}
        WHERE user_id = #{userId}
    </update>

    <select id="findDepartmentMember" parameterType="com.dgg.store.util.vo.team.DepartmentMemberVO" resultMap="DepartmentMemberVOMap">
        SELECT u.user_id,u.user_name,u.user_phone,u.user_sex,u.team_department_id,u.role_id,
			td.team_department_id,td.team_department_name
        FROM dgg_store.user u
        INNER JOIN dgg_store.team_department td
        ON td.team_department_id = u.team_department_id
        WHERE u.team_department_id =  #{teamDepartmentId}
    </select>

    <select id="findDepartmentMemberInfo" resultMap="DepartmentMemberVOMap">
        SELECT u.user_id,u.user_name,u.user_phone,u.user_sex,u.user_birthday,u.user_area,u.user_address,u.role_id,
            mt.my_team_name,
            td.team_department_name
        FROM dgg_store.user u
        INNER JOIN dgg_store.my_team mt
        ON mt.my_team_id = u.my_team_id
        INNER JOIN dgg_store.team_department td
        ON td.team_department_id = u.team_department_id
        WHERE u.user_id = #{userId}
    </select>

    <select id="findCDepartmentList" resultMap="DepartmentMap">
        SELECT td.team_department_id,td.team_department_name,
            (SELECT u.user_name FROM dgg_store.user u WHERE u.team_department_id = td.team_department_id AND u.role_id > #{roleId}) user_name,
            (SELECT u.user_phone FROM dgg_store.user u WHERE u.team_department_id = td.team_department_id AND u.role_id > #{roleId}) user_phone,
            (SELECT COUNT(1) FROM user u WHERE u.team_department_id = td.team_department_id) count
        FROM dgg_store.team_department td
        INNER JOIN dgg_store.my_team mt
        ON mt.my_team_id = td.my_team_id
        WHERE mt.my_team_id = #{teamId}
    </select>

    <update id="updateDepartment" parameterType="com.dgg.store.util.vo.team.DepartmentMemberVO">
        UPDATE dgg_store.user u
        <set>
            <if test="roleId != null and roleId != ''">
                u.role_id = #{roleId},
            </if>
            <if test="teamDepartmentId != null and teamDepartmentId != ''">
                u.team_department_id = #{teamDepartmentId},
            </if>
        </set>
        WHERE u.user_id = #{userId}
    </update>

    <select id="findDepartmentManager" resultMap="DepartmentVOMap">
        SELECT u.user_id,u.user_phone,u.user_name
        FROM dgg_store.user u
        WHERE u.team_department_id = #{departmentId}
        AND u.role_id > #{roleId}
    </select>

    <select id="findDepartmentTree" resultMap="TreeMap">
        SELECT td.team_department_id id,td.team_department_name name,td.my_team_id pid
        FROM dgg_store.team_department td
        WHERE td.my_team_id = #{teamId}
    </select>

    <select id="findChildTeamTree" resultMap="TreeMap">
        SELECT mt.my_team_id id,mt.my_team_name name,mt.my_team_pid pid
        FROM dgg_store.my_team mt
        WHERE mt.my_team_pid = #{teamId}
    </select>
</mapper>