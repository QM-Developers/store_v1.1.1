<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dgg.store.mapper.CustomerMapper">
    <resultMap id="CustomerVOMap" type="com.dgg.store.util.vo.CustomerVO">
        <result column="user_id" property="customerId" jdbcType="VARCHAR"/>
        <result column="user_name" property="userName" jdbcType="VARCHAR"/>
        <result column="user_img" property="userImg" jdbcType="VARCHAR"/>
        <result column="user_phone" property="userPhone" jdbcType="VARCHAR"/>
        <result column="user_area" property="userArea" jdbcType="VARCHAR"/>
        <result column="user_sex" property="userSex" jdbcType="VARCHAR"/>
        <result column="user_birthday" property="userBirthday" jdbcType="VARCHAR"/>
        <result column="user_address" property="userAddress" jdbcType="VARCHAR"/>
        <result column="my_team_id" property="myTeamId" jdbcType="VARCHAR"/>
        <result column="customer_remard" property="customerRemard" jdbcType="VARCHAR"/>
        <result column="customer_group_name" property="customerGroupName" jdbcType="VARCHAR"/>
        <result column="customer_group_id" property="customerGroupId" jdbcType="VARCHAR"/>
        <result column="user_status" property="userStatus" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="MyTeamMap" type="com.dgg.store.util.pojo.MyTeam">
        <result column="my_team_id" property="myTeamId" jdbcType="VARCHAR"/>
        <result column="my_team_name" property="myTeamName" jdbcType="VARCHAR"/>
        <result column="my_team_area" property="myTeamArea" jdbcType="VARCHAR"/>
        <result column="my_team_address" property="myTeamAddress" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="CustomerGroupMap" type="com.dgg.store.util.vo.CustomerGroupVO">
        <id column="customer_group_id" property="customerGroupId" jdbcType="VARCHAR"/>
        <result column="customer_group_name" property="customerGroupName" jdbcType="VARCHAR"/>
    </resultMap>

    <insert id="insertStoreUser" parameterType="com.dgg.store.util.vo.CustomerVO">
        insert into user (user_id, role_id, user_name,
            user_sex, user_phone,my_team_id,
            user_birthday, user_address, user_area,
            user_create_date, user_status)
        values (#{customerId},#{roleId},#{userName},
            #{userSex},#{userPhone},#{myTeamId},
            #{userBirthday},#{userAddress},#{userArea},
            NOW(),#{userStatus})
    </insert>

    <insert id="insertCustomerGroup" parameterType="com.dgg.store.util.vo.CustomerVO">
        INSERT INTO customer(customer_group_id, customer_id,user_id)
        VALUES
        (#{customerGroupId},#{customerId},#{userId})
    </insert>

    <select id="findCustomerInfo" resultMap="CustomerVOMap">
        select u.user_name,u.user_status,u.user_phone,u.user_img,u.user_sex,u.user_birthday,u.user_address,u.user_area,u.my_team_id,c.customer_group_id
        from customers c
        right join user u
        on u.user_id = c.user_id
        where u.user_id = #{userId}
    </select>

    <select id="findCustomerByGroup" resultMap="CustomerVOMap">
        SELECT u.user_id,u.user_name,u.user_sex,u.user_phone,dt_state.dict_name user_status,cg.customer_group_name
        FROM customer c
        INNER JOIN customer_group cg
        ON cg.customer_group_id = c.customer_group_id
        INNER JOIN user u
        ON u.user_id = c.user_id
        INNER JOIN dictionary dt_state
        ON dt_state.dict_code = u.user_status
        WHERE cg.customer_group_id = #{groupId}
        AND c.promoter_id = #{userId}
        UNION
        SELECT u.user_id,u.user_name,u.user_sex,u.user_phone,dt_state.dict_name user_status,cg.customer_group_name
        FROM customer c
        INNER JOIN customer_group cg
        ON cg.customer_group_id = c.customer_group_id
        INNER JOIN user_record u
        ON u.user_id = c.user_id
        INNER JOIN dictionary dt_state
        ON dt_state.dict_code = u.user_status
        WHERE cg.customer_group_id = #{groupId}
        AND c.promoter_id = #{userId}
    </select>

    <select id="findPartner" resultMap="CustomerVOMap">
        SELECT u.user_id,u.user_name,u.user_img,u.user_phone,u.user_status,u.user_area
        FROM user u
        WHERE u.my_team_id = #{cooperId}
    </select>

    <select id="findCustomerGroup" resultMap="CustomerGroupMap">
        SELECT customer_group_id,dt.dict_name customer_group_name
        FROM customer_group
        INNER JOIN dictionary dt
        ON customer_group_name = dt.dict_code
    </select>

    <insert id="insertCooperation" useGeneratedKeys="true" keyProperty="myTeamId" parameterType="com.dgg.store.util.pojo.MyTeam">
        INSERT INTO my_team(my_team_name, my_team_uid,my_team_area,my_team_address)
        VALUES
        (#{myTeamName},#{myTeamUid},#{myTeamArea},#{myTeamAddress})
    </insert>

    <select id="findCooperation" resultMap="MyTeamMap">
        SELECT t.my_team_id,t.my_team_name,t.my_team_area,t.my_team_address
        FROM my_team t
        WHERE t.my_team_uid = #{userId}
    </select>

    <update id="updateCustomer" parameterType="com.dgg.store.util.vo.CustomerVO">
        UPDATE user
        <set>
            <if test="userName != null">
                user_name = #{userName},
            </if>
            <if test="userArea != null">
                user_area = #{userArea},
            </if>
            <if test="userAddress != null">
                user_address = #{userAddress},
            </if>
            <if test="userSex != null">
                user_sex = #{userSex},
            </if>
            <if test="userBirthday != null">
                user_birthday = #{userBirthday},
            </if>
        </set>
        WHERE user_phone = #{userPhone} AND my_team_id = #{myTeamId}
    </update>

    <insert id="insertCustomerHistory">
        INSERT INTO user_records(user_id, team_classify_id, my_team_id, role_id, user_name, user_password, user_sex, user_phone, user_birthday, user_address, user_area, user_email, user_last_login_time, user_status, user_qq, uesr_wechat, user_img, user_nickname, hx_name, hx_password,user_create_date)
        SELECT user_id, team_classify_id, my_team_id, role_id, user_name, user_password, user_sex, user_phone, user_birthday, user_address, user_area, user_email, user_last_login_time, user_status, user_qq, uesr_wechat, user_img, user_nickname, hx_name, hx_password,now()
        FROM user
        WHERE user_id = #{userId}
    </insert>

    <insert id="insertCustomerRecord" parameterType="com.dgg.store.util.vo.CustomerVO">
        INSERT INTO user_record(
            user_id, my_team_id, role_id,
            user_name, user_sex, user_phone,
            user_birthday, user_address, user_area,
            user_status,user_identity, lng_and_lat)
        VALUES (#{userId},#{myTeamId},#{roleId},
            #{userName},#{userSex},#{userPhone},
            #{userBirthday},#{userAddress},#{userArea},
            #{userStatus},#{userIdentity},#{lngAndLat})
    </insert>

    <insert id="insertCustomer" parameterType="com.dgg.store.util.vo.CustomerVO">
        INSERT INTO customer (
            user_id, customer_id, customer_group_id,
            credit_rating, promoter_id)
        VALUES (#{userId},#{customerId},#{customerGroupId},
            #{creditRating},#{promoterId})
    </insert>
</mapper>