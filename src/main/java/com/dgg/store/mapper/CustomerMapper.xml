<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dgg.store.mapper.CustomerMapper">
    <resultMap id="CustomerVO" type="com.dgg.store.util.vo.CustomerVO">
        <result column="customer_id" property="customerId" jdbcType="VARCHAR"/>
        <result column="user_name" property="userName" jdbcType="VARCHAR"/>
        <result column="user_phone" property="userPhone" jdbcType="VARCHAR"/>
        <result column="user_sex" property="userSex" jdbcType="VARCHAR"/>
        <result column="user_birthday" property="userBirthday" jdbcType="VARCHAR"/>
        <result column="user_address" property="userAddress" jdbcType="VARCHAR"/>
        <result column="credit_rating" property="creditRating" jdbcType="INTEGER"/>
        <result column="business_address" property="businessAddress" jdbcType="VARCHAR"/>
        <result column="station" property="station" jdbcType="VARCHAR"/>
        <result column="customer_type" property="customerType" jdbcType="VARCHAR"/>
        <result column="had_account" property="hadAccount" jdbcType="INTEGER"/>
        <result column="user_card_front" property="userCardFront" jdbcType="VARCHAR"/>
        <result column="user_card_back" property="userCardBack" jdbcType="VARCHAR"/>
        <result column="user_card_hand" property="userCardHand" jdbcType="VARCHAR"/>
        <result column="update_date" property="userUpdateTime" jdbcType="VARCHAR"/>
        <result column="update_count" property="updateCount" jdbcType="INTEGER"/>
    </resultMap>

    <insert id="insertCustomerRecord" parameterType="com.dgg.store.util.vo.CustomerVO">
        INSERT INTO user_record
        (user_id,my_team_id,user_name,user_phone,
        user_birthday,user_address,user_sex,
        user_status,role_id)
        VALUES
        (#{userId},#{myTeamId},#{userName},#{userPhone},
        #{userBirthday},#{userAddress},#{userSex},
        #{userStatus},#{roleId})
    </insert>

    <insert id="insertCustomer" parameterType="com.dgg.store.util.vo.CustomerVO">
        INSERT INTO customer
        (customer_id, user_id, promoter_id,
        my_team_id, business_address, station,
        credit_rating,customer_type)
        VALUES (#{customerId},#{userId},#{promoterId},
        #{myTeamId},#{businessAddress},#{station},
        #{creditRating},#{customerType})
    </insert>

    <select id="listCustomer" resultMap="CustomerVO">
        SELECT c.customer_id,c.business_address,c.credit_rating,
            c.customer_type,c.station,c.had_account,
            u.user_name,u.user_phone,u.user_birthday,
            u.user_address,u.user_sex
        FROM customer c
        INNER JOIN user_view u
        ON u.user_id = c.user_id
        WHERE c.my_team_id = #{customer.myTeamId}
        AND c.promoter_id = #{customer.userId}
        <if test="customer.customerType != null and customer.customerType != ''">
            AND c.customer_type = #{customer.customerType}
        </if>
        LIMIT #{start},#{end}
    </select>

    <select id="countCustomer" parameterType="com.dgg.store.util.vo.CustomerVO" resultType="java.lang.Integer">
        SELECT COUNT(0)
        FROM customer c
        INNER JOIN user_view u
        ON u.user_id = c.user_id
        WHERE c.my_team_id = #{myTeamId}
        AND c.promoter_id = #{userId}
        <if test="customerType != null and customerType != ''">
            AND c.customer_type = #{customerType}
        </if>
    </select>

    <update id="updateCustomerUserRecord" parameterType="com.dgg.store.util.vo.CustomerVO">
        UPDATE user_record
        <set>
            <if test="userName != null">
                user_name = #{userName},
            </if>
            <if test="userPhone != null">
                user_phone = #{userPhone},
            </if>
            <if test="userSex != null">
                user_sex = #{userSex},
            </if>
            <if test="userBirthday != null">
                user_birthday = #{userBirthday},
            </if>
            <if test="userAddress != null">
                user_address = #{userAddress},
            </if>
        </set>
        WHERE user_id = (SELECT user_id FROM customer WHERE customer_id = #{customerId})
    </update>

    <update id="updateCustomerUser" parameterType="com.dgg.store.util.vo.CustomerVO">
        UPDATE user
        <set>
            <if test="userName != null">
                user_name = #{userName},
            </if>
            <if test="userPhone != null">
                user_phone = #{userPhone},
            </if>
            <if test="userSex != null">
                user_sex = #{userSex},
            </if>
            <if test="userBirthday != null">
                user_birthday = #{userBirthday},
            </if>
            <if test="userAddress != null">
                user_address = #{userAddress},
            </if>
        </set>
        WHERE user_id = (SELECT user_id FROM customer WHERE customer_id = #{customerId})
    </update>

    <update id="updateCustomer" parameterType="com.dgg.store.util.vo.CustomerVO">
        UPDATE customer
        <set>
            <if test="promoterId != null">
                promoter_id = #{promoterId},
            </if>
            <if test="businessAddress != null">
                business_address = #{businessAddress},
            </if>
            <if test="station != null">
                station = #{station},
            </if>
            <if test="creditRating != null">
                credit_rating = #{creditRating},
            </if>
            update_date = now(),
            count_update = (SELECT count_update + 1 FROM customer WHERE customer_id = #{customerId}),
        </set>
        WHERE customer_id = #{customerId}
    </update>

    <select id="getCustomer" resultMap="CustomerVO">
        SELECT c.customer_id,c.customer_type,c.had_account,
            c.credit_rating,c.business_address,c.station,
            c.update_count,c.update_date,
            u.user_name,u.user_phone,u.user_birthday,
            u.user_address,u.user_sex,u.user_create_date,
            u.user_card_front,u.user_card_back,u.user_card_hand
        FROM customer c
        INNER JOIN user_view u
        ON u.user_id = c.user_id
        WHERE c.customer_id = #{customerId}
    </select>

    <update id="insertFrontImage">
        UPDATE user u,user_record re
        SET u.user_card_front = #{fileName},re.user_card_front = #{fileName}
        WHERE u.user_id = (SELECT user_id FROM customer WHERE customer_id = #{customerId})
        OR re.user_id = (SELECT user_id FROM customer WHERE customer_id = #{customerId})
    </update>

    <update id="insertBackImage">
        UPDATE user u,user_record re
        SET u.user_card_back = #{fileName},re.user_card_back = #{fileName}
        WHERE u.user_id = (SELECT user_id FROM customer WHERE customer_id = #{customerId})
        OR re.user_id = (SELECT user_id FROM customer WHERE customer_id = #{customerId})
    </update>

    <update id="insertHandImage">
        UPDATE user u,user_record re
        SET u.user_card_hand = #{fileName},re.user_card_hand = #{fileName}
        WHERE u.user_id = (SELECT user_id FROM customer WHERE customer_id = #{customerId})
        OR re.user_id = (SELECT user_id FROM customer WHERE customer_id = #{customerId})
    </update>
</mapper>